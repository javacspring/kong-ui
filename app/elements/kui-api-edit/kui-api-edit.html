<!--
@license
Copyright (c) 2015 Mike Saraf. All rights reserved.
This code may only be used under the BSD style license found in the included file LICENSE.md
-->

<dom-module id="kui-api-edit">
  <!--<link rel="import" href="../../../bower_components/paper-input/paper-input.html">-->
  <!--<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">-->
  <!--<link rel="import" href="../../../bower_components/paper-material/paper-material.html">-->
  <!--<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">-->
  <!--<link rel="import" href="../../../bower_components/iron-input/iron-input.html">-->

  <style>
    :host {
      /*display: block;*/
      width: 100%;

      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      flex-wrap: nowrap;
    }

    kui-toolbar {
      flex-grow: 0;
      flex-shrink: 0;
    }

    #form {
      flex-grow: 1;
      flex-shrink: 0;

      display:flex;
      flex-direction: column;
      flex-wrap: nowrap;
      justify-content: flex-start;
      align-items: center;

      align-self: center;
      background-color: #fff;

      width: 90%;
      margin-top: 18px;
      padding-top: 10px;
      padding-bottom: 10px;
      padding-left: 10px;
      padding-right: 10px;

    }

    #form > * {
      width: 100%;
    }



    @media (max-width: 600px) {
      h1.paper-font-display1 {
        font-size: 24px;
      }
    }
  </style>
  <template>
    <kui-toolbar>
      <div crumbtrail><span>{{crumbTrail}}</span></div>
      <div icontray>
        <paper-icon-button icon="delete" on-tap="_delete" hidden$="{{newMode}}"></paper-icon-button>
        <paper-icon-button icon="close" on-tap="_cancel"></paper-icon-button>
        <paper-icon-button icon="check" on-tap="_save"></paper-icon-button>
      </div>
    </kui-toolbar>

    <iron-ajax id="ajax" debounce-duration="300"></iron-ajax>

    <!--<div id="form">-->
    <paper-material id="form">
      <!--<label>id <span>{{foo}}</span></label>-->

      <paper-input id="uuid" label="id" value="whatwhat" disabled hidden$="{{newMode}}"></paper-input>
      <paper-input id="name" label="name"></paper-input>
      <paper-input id="public_dns" label="public_dns"></paper-input>
      <paper-input id="path" label="path"></paper-input>
      <paper-checkbox id="strip_path" label="strip_path">strip_path</paper-checkbox>
      <paper-input id="target_url" label="target_url"></paper-input>
      <paper-input id="created_at" label="created_at" disabled hidden$="{{newMode}}"></paper-input>
    </paper-material>

    <paper-toast id="toast" duration="3000" style="z-index: 1000"></paper-toast>
  </template>

  <script>
    (function() {
      Polymer({
        is: 'kui-api-edit',

        properties: {
          item: {
            type: Object
          }
        },

        context: Object,
        apiName: String,
        crumbTrail: String,
        newMode: Boolean,



        /* --- Private --- */

        _reset: function() {
          // Clear Form
          //this.$.uuid.value = "";
          this.$.name.value = "";
          this.$.public_dns.value = "";
          this.$.path.value = "";
          this.$.strip_path.value = "";
          this.$.target_url.valuej = "";
          this.$.created_at.value = "";

          this.apiName = null;
          this.crumbTrail = null;
          this.newMode = true;
          this.api = null;
        },

        _cancel: function() {
          console.log("Cancel API add/edit");
          this._reset();
          page('/');
        },

        _save: function() {

          if(this.newMode) {
            console.log("Create new API");

            var api = new Object();
              api.name = this.$.name.inputElement.value;
              api.public_dns = this.$.public_dns.inputElement.value;
              api.path = this.$.path.inputElement.value;
              api.strip_path = this.$.strip_path.checked;
              api.target_url = this.$.target_url.inputElement.value;

            this.$.ajax.url= this.context.settings.servers[0].address + "/apis"
            this.$.ajax.body = JSON.stringify(api);
            //this.$.ajax.body = this._transformRequest(api);
            this.$.ajax.contentType = "application/json";
            //this.$.ajax.contentType = "x-www-form-urlencoded";
            this.$.ajax.method = "POST";
          } else {
            console.log("TODO: Update API: " + this.api.name);
          }

          this.$.ajax.generateRequest();
        },

        _delete: function() {
          this._toastError("Delete not implemented.");
        },

        _handleResponse: function(response) {
          //console.log(response.detail.response.name);
          this.parentNode._toastSuccess("Created: " + response.detail.response.name);
          this.parentNode._reset();
          page('/apis/' + response.detail.response.name);
        },

        _handleError: function(response) {
          this.parentNode._toastError(response.detail.error.message);
        },

        _transformRequest: function(obj) {
          var str = [];
          for(var p in obj)
            str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
          return str.join("&");
        },

        _toastInfo: function(msg) {
          this.$.toast.text = msg;
          this.$.toast.duration = 3000;
          this.$.toast.style.backgroundColor = "gray";
          this.$.toast.show();
        },

        _toastError: function(msg) {
          this.$.toast.text = msg;
          this.$.toast.duration = 6000;
          this.$.toast.style.backgroundColor = "red";
          this.$.toast.show();
        },

        _toastSuccess: function(msg) {
          this.$.toast.text = msg;
          this.$.toast.duration = 3000;
          this.$.toast.style.backgroundColor = "green";
          this.$.toast.show();
        },

        /* --- Public --- */
        create: function(c) {
          this._reset();

          if(c == null)
            console.error("kui-api-edit.create: Cannot pass null value for context.");

          this.context = c;
          this.apiName = null;
          this.crumbTrail = "New";
          this.newMode = true;
        },

        edit: function(c, apiName) {
          this._reset();

          if(c == null)
            console.error("kui-api-edit.edit: Cannot pass null value for context.");
          if(apiName == null)
            console.error("kui-api-edit.edit: Cannot pass null value for apiName.");

          this.context = c;
          this.apiName = apiName;
          this.crumbTrail = apiName;
          this.newMode = false;


        },

        /* --- Life Cycle --- */
        ready: function() {
          this.$.ajax.addEventListener('response', this._handleResponse);
          this.$.ajax.addEventListener('error', this._handleError);
        }
      });
    })();
  </script>

</dom-module>
